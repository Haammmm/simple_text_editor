# SimpleTextEditor 简易文本编辑器

## 项目简介

SimpleTextEditor 是一个用 C/C++ 编写的轻量级控制台文本编辑器，灵感来自 Vim。它支持 UTF-8 文本操作、基本编辑命令和 Windows DLL 插件系统。项目包含一个示例 LLM 插件，演示如何通过 [`openai-cpp`](https://github.com/olrea/openai-cpp) 进行集成。

## 核心特性

### 文本编辑功能
- **基于行的编辑**：支持插入/删除行
- **子串操作**：子串插入、替换、删除
- **字符操作**：单个字符替换
- **UTF-8 支持**：完整的 UTF-8 字符编码支持，包括中文字符

### 文本分析
- **子串查找**：基于 KMP 算法的高效 UTF-8 子串搜索
- **字符统计**：
  - 英文字母计数
  - 数字计数
  - 空格计数
  - 标点符号计数
  - 中文字符（CJK）计数
  - 其他字符计数

### 文件操作
- 打开文本文件（支持 UTF-8 编码）
- 保存文本文件
- 自动处理过长行（截断保护）
- 使用安全 CRT API（`*_s` 系列函数）

### 插件系统
- 从 `plugins` 目录自动加载 DLL 插件
- 通过 `EditorAPI` 注册自定义命令
- 示例 LLM 插件（`LLMDialog`）展示如何通过工具调用读写编辑器缓冲区

## 系统要求

### 操作系统
- Windows（插件管理器和 LLM 插件使用 WinHTTP 进行 HTTP 请求）

### 开发环境
- Visual Studio（支持 C17/C++20）
- Windows SDK（提供 `winhttp.lib`）
- 可选：`openai-cpp` 头文件（用于构建 LLM 插件 `Dll1` 项目）

## 编译指南

### 步骤

1. **打开解决方案**
   - 使用 Visual Studio 打开 `Project1.slnx` 或相应的解决方案文件

2. **配置链接器设置**
   - 确保在项目设置中链接了 `winhttp.lib`
   - 路径：项目属性 → 链接器 → 输入 → 附加依赖项

3. **构建项目**
   - 构建 `Project1`（控制台应用程序）
   - 构建 `Dll1`（LLM 插件 DLL）

4. **部署插件**
   - 将构建好的 DLL 插件复制到 `./plugins` 目录（与可执行文件同级）
   - 插件将在运行时自动加载

## 使用指南

### 启动程序

运行控制台应用程序（`Project1`），将看到以下主菜单：

```
╔══════════════════════════════════════════╗
║         简易文本编辑器 v1.0              ║
╠══════════════════════════════════════════╣
║  1. 新建/输入文本内容                    ║
║  2. 打开文本文件                         ║
║  3. 保存文本文件                         ║
║  4. 统计字符信息                         ║
║  5. 查找子串出现次数                     ║
║  6. 在指定位置插入子串                   ║
║  7. 修改指定位置字符/子串                ║
║  8. 删除指定子串                         ║
║  9. 显示当前文本                         ║
║ 10. 插件管理                             ║
║  0. 退出系统                             ║
╚══════════════════════════════════════════╝
```

### 基本操作

#### 1. 输入文本
- 选择菜单选项 1
- 逐行输入文本内容
- 输入空行结束输入
- 支持追加到现有文本或清空后重新输入

#### 2. 打开文件
- 选择菜单选项 2
- 输入文件路径
- 系统将读取并显示文件内容
- 如果当前有未保存的修改，系统会提示确认

#### 3. 保存文件
- 选择菜单选项 3
- 可以保存到当前文件或另存为新文件
- 系统会自动记录文件名

#### 4. 字符统计
- 选择菜单选项 4
- 查看当前文本的详细字符统计：
  - 英文字母数
  - 中文字符数
  - 数字个数
  - 空格个数
  - 标点符号数
  - 其他字符数
  - 总字符数

#### 5. 查找子串
- 选择菜单选项 5
- 输入要查找的子串
- 系统将显示所有匹配位置（行号和列号）
- 使用 KMP 算法确保高效查找

#### 6. 插入子串
- 选择菜单选项 6
- 指定行号和列号（基于字符位置，支持 UTF-8）
- 输入要插入的子串
- 系统将在指定位置插入文本

#### 7. 修改文本
- 选择菜单选项 7
- 提供三种修改方式：
  1. 修改指定位置的单个字符
  2. 修改指定位置的子串
  3. 替换所有匹配的子串
- 按提示输入相关参数

#### 8. 删除子串
- 选择菜单选项 8
- 输入要删除的子串
- 系统会统计匹配数量并要求确认
- 确认后删除所有匹配的子串

#### 9. 显示文本
- 选择菜单选项 9
- 显示当前文本内容和字符统计信息

#### 10. 插件管理
- 选择菜单选项 10
- 进入插件管理子菜单：
  1. 扫描并加载 plugins 目录下的 DLL 插件
  2. 列出已加载的插件命令
  3. 执行插件命令
  4. 返回主菜单

### 插件系统使用

#### 加载插件
1. 将 DLL 文件放入 `./plugins` 目录
2. 在插件管理菜单中选择"扫描并加载插件"
3. 系统将自动加载并初始化所有有效的插件

#### 执行插件命令
1. 选择"列出插件命令"查看可用命令
2. 选择"执行插件命令"
3. 输入命令名称（如 `LLMDialog`）
4. 按照插件提示进行操作

## LLM 插件详解

### 功能说明

LLM 插件（`LLMDialog`）位于 `Dll1/openai_agent.cpp`，提供与大语言模型的交互能力。

### 主要特性

- 使用 [`openai-cpp`](https://github.com/olrea/openai-cpp) 库进行 API 调用
- 支持通过工具调用更新编辑器缓冲区
- 提供以下工具函数：
  - `apply_editor`：覆盖编辑器缓冲区内容
  - `get_buffer`：获取当前编辑器缓冲区内容

### 配置要求

#### 环境变量
设置环境变量 `test_apikey` 为你的 API 密钥：
```cmd
set test_apikey=your_api_key_here
```

#### API 端点配置
默认配置指向 ModelScope：
- Base URL: `https://api-inference.modelscope.cn/v1/`
- Model: `deepseek-ai/DeepSeek-V3.2`

如需更改提供商，请修改 `Dll1/openai_agent.cpp` 中的 `kBaseUrl` 和 `kModel` 常量。

### 使用流程

1. 确保设置了 `test_apikey` 环境变量
2. 在插件管理中加载插件
3. 执行 `LLMDialog` 命令
4. 输入你的指令（单行）
5. LLM 将分析当前缓冲区内容并执行相应操作
6. 如果需要修改缓冲区，LLM 会通过 `apply_editor` 工具调用更新内容

### 工作原理

1. **上下文发送**：将当前编辑器缓冲区内容和用户指令发送给 LLM
2. **工具调用处理**：LLM 可以调用工具函数来读取或修改缓冲区
3. **结果展示**：LLM 的回复和操作结果会显示在控制台
4. **迭代对话**：支持多轮工具调用（最多 4 次安全限制）

## 插件开发指南

### 基本结构

要开发自己的插件，需要：

1. **实现初始化函数**
```c
__declspec(dllexport) int PluginInit(EditorAPI* api);
```

2. **注册命令**
```c
api->register_command("CommandName", command_function, "Command description");
```

3. **使用 EditorAPI**
插件可以通过 `EditorAPI` 访问以下功能：
- `get_line_count()`：获取行数
- `get_line(int line_num)`：获取指定行内容
- `insert_line(int line_num, const char* text)`：插入行
- `delete_line(int line_num)`：删除行
- `replace_line(int line_num, const char* text)`：替换行
- `print_msg(const char* msg)`：输出消息
- `clear_screen()`：清屏
- `read_file(const char* path, char* out, size_t out_sz)`：读取文件
- `write_file(const char* path, const char* data)`：写入文件
- `http_get(const char* url, char* out, size_t out_sz)`：HTTP GET 请求

### 示例插件

参考 `Dll1/openai_agent.cpp` 中的实现：

```cpp
extern "C" {
__declspec(dllexport) int PluginInit(EditorAPI* api) {
    if (!api) return -1;
    
    // 保存 API 指针
    g_api = api;
    
    // 注册命令
    g_api->register_command(
        "LLMDialog", 
        cmd_llm_dialog, 
        "Chat with LLM (C++ Modern); tool updates buffer"
    );
    
    return 0;
}
}
```

### 部署插件

1. 将编译好的 DLL 文件复制到 `./plugins` 目录
2. DLL 文件名可以任意，系统会扫描所有 `.dll` 文件
3. 确保 DLL 导出了 `PluginInit` 函数

## 配置说明

### 插件目录
- 默认路径：`./plugins`（与可执行文件同级目录）
- 可以在程序中修改插件扫描路径

### 环境变量
- `test_apikey`：LLM 插件的 API 密钥
- 用于访问 ModelScope 或其他兼容的 API 端点

### 限制和约束
- 最大行数：1000 行（`MAX_LINES`）
- 最大行长度：4096 字符（`MAX_LINE_LENGTH`）
- 最大文件名长度：256 字符（`MAX_FILENAME`）
- 最大加载插件数：32 个

## 技术特点

### UTF-8 编码支持
- 完整的 UTF-8 字符处理
- 支持 CJK（中日韩）字符
- 正确计算字符位置（区分字节和字符）
- 全角/半角字符识别

### KMP 字符串匹配
- 使用 KMP（Knuth-Morris-Pratt）算法进行子串查找
- 时间复杂度：O(n+m)
- 支持 UTF-8 多字节字符

### 安全编程实践
- 使用安全 CRT 函数（`*_s` 系列）
- 避免缓冲区溢出
- 字符串截断保护（`_TRUNCATE`）
- 输入验证和边界检查

### 跨平台考虑
- 核心编辑功能可移植
- Windows 特定功能：
  - WinHTTP（HTTP 客户端）
  - DLL 插件加载
  - 可以适配到其他平台（需替换 Windows API）

## 注意事项

### 文件编码
- 建议使用 UTF-8 编码的文本文件
- 其他编码可能导致显示或处理问题

### 行长度限制
- 超过 4096 字符的行将被截断
- 保存时会自动处理

### 插件安全性
- 插件以 DLL 形式加载，具有与主程序相同的权限
- 只加载可信来源的插件
- 插件错误可能导致程序崩溃

### LLM 插件限制
- 需要网络连接
- API 调用可能产生费用
- 响应时间取决于网络和 API 性能
- 默认使用 ModelScope，可能有地区限制

## 故障排除

### 编译错误
- 确保链接了 `winhttp.lib`
- 检查 Windows SDK 版本
- 确保 C17/C++20 支持已启用

### 插件加载失败
- 检查 DLL 是否在 `./plugins` 目录
- 确保 DLL 导出了 `PluginInit` 函数
- 检查 DLL 的架构（32位/64位）与主程序匹配

### LLM 插件问题
- 确认 `test_apikey` 环境变量已设置
- 检查网络连接
- 验证 API 密钥有效性
- 查看控制台错误信息

### 文件操作失败
- 检查文件路径是否正确
- 确认文件权限
- 验证文件编码为 UTF-8

## 项目结构

```
simple_text_editor/
├── Project1/                    # 主项目（控制台应用）
│   └── SimpleTextEditor/
│       ├── main.c              # 主程序入口和 UI
│       ├── text_editor.h       # 文本编辑器头文件
│       ├── text_editor.c       # 文本编辑器核心实现
│       ├── plugin_manager.h    # 插件管理器头文件
│       ├── plugin_manager.c    # 插件管理器实现
│       └── plugin.h            # 插件接口定义
├── Dll1/                        # LLM 插件项目
│   ├── openai_agent.cpp        # LLM 插件实现
│   ├── openai/                 # openai-cpp 库
│   │   ├── openai.hpp
│   │   └── nlohmann/
│   │       └── json.hpp
│   ├── dllmain.cpp
│   ├── pch.h
│   ├── pch.cpp
│   └── framework.h
├── plugins/                     # 插件目录（运行时）
├── README.md                    # 英文文档
├── 中文文档.md                  # 本文档
├── LICENSE.txt                  # MIT 许可证
└── Project1.slnx               # Visual Studio 解决方案

```

## 贡献指南

欢迎贡献代码、报告问题或提出建议！

### 如何贡献
1. Fork 本仓库
2. 创建特性分支（`git checkout -b feature/AmazingFeature`）
3. 提交更改（`git commit -m 'Add some AmazingFeature'`）
4. 推送到分支（`git push origin feature/AmazingFeature`）
5. 开启 Pull Request

### 代码规范
- 遵循现有代码风格
- 使用安全 CRT 函数
- 添加适当的注释
- 确保 UTF-8 兼容性

### 问题报告
- 描述问题的详细步骤
- 提供系统信息和环境配置
- 如有可能，附上错误信息和日志

## 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE.txt](LICENSE.txt) 文件。

## 鸣谢

- [openai-cpp](https://github.com/olrea/openai-cpp) - OpenAI API 的 C++ 客户端库
- [nlohmann/json](https://github.com/nlohmann/json) - 用于现代 C++ 的 JSON 库

## 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

**注意**：本项目处于持续开发中，功能和 API 可能会发生变化。
